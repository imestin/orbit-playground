{"ast":null,"code":"const path = require('path');\n\nconst fs = require('../fs-shim');\n\nconst Cache = require('orbit-db-cache');\n\nconst Logger = require('logplease');\n\nconst logger = Logger.create('orbit-db');\nLogger.setLogLevel('ERROR');\n\nasync function migrate(OrbitDB, options, dbAddress) {\n  let oldCache = OrbitDB.caches[options.directory] ? OrbitDB.caches[options.directory].cache : null;\n  let oldStore;\n\n  if (!oldCache) {\n    const addr = (path.posix || path).join(OrbitDB.directory, dbAddress.root, dbAddress.path);\n    if (fs && fs.existsSync && !fs.existsSync(addr)) return;\n    oldStore = await OrbitDB.storage.createStore(addr);\n    oldCache = new Cache(oldStore);\n  }\n\n  const _localHeads = await oldCache.get('_localHeads');\n\n  if (!_localHeads) return;\n  const keyRoot = dbAddress.toString();\n  logger.debug('Attempting to migrate from old cache location');\n  const migrationKeys = ['_remoteHeads', '_localHeads', 'snapshot', 'queue'];\n\n  for (const i in migrationKeys) {\n    try {\n      const key = path.join(keyRoot, migrationKeys[i]);\n      const val = await oldCache.get(migrationKeys[i]);\n      if (val) await options.cache.set(key, val);\n    } catch (e) {\n      logger.debug(e.message);\n    }\n  }\n\n  await options.cache.set(path.join(keyRoot, '_manifest'), dbAddress.root);\n  if (oldStore) await oldStore.close();\n}\n\nmodule.exports = migrate;","map":{"version":3,"sources":["/home/user/orbit-playground/music-app/node_modules/orbit-db/src/migrations/0.21-0.22.js"],"names":["path","require","fs","Cache","Logger","logger","create","setLogLevel","migrate","OrbitDB","options","dbAddress","oldCache","caches","directory","cache","oldStore","addr","posix","join","root","existsSync","storage","createStore","_localHeads","get","keyRoot","toString","debug","migrationKeys","i","key","val","set","e","message","close","module","exports"],"mappings":"AAAA,MAAMA,IAAI,GAAGC,OAAO,CAAC,MAAD,CAApB;;AACA,MAAMC,EAAE,GAAGD,OAAO,CAAC,YAAD,CAAlB;;AAEA,MAAME,KAAK,GAAGF,OAAO,CAAC,gBAAD,CAArB;;AAEA,MAAMG,MAAM,GAAGH,OAAO,CAAC,WAAD,CAAtB;;AACA,MAAMI,MAAM,GAAGD,MAAM,CAACE,MAAP,CAAc,UAAd,CAAf;AACAF,MAAM,CAACG,WAAP,CAAmB,OAAnB;;AAEA,eAAeC,OAAf,CAAwBC,OAAxB,EAAiCC,OAAjC,EAA0CC,SAA1C,EAAqD;AACnD,MAAIC,QAAQ,GAAGH,OAAO,CAACI,MAAR,CAAeH,OAAO,CAACI,SAAvB,IAAoCL,OAAO,CAACI,MAAR,CAAeH,OAAO,CAACI,SAAvB,EAAkCC,KAAtE,GAA8E,IAA7F;AACA,MAAIC,QAAJ;;AAEA,MAAI,CAACJ,QAAL,EAAe;AACb,UAAMK,IAAI,GAAG,CAACjB,IAAI,CAACkB,KAAL,IAAclB,IAAf,EAAqBmB,IAArB,CAA0BV,OAAO,CAACK,SAAlC,EAA6CH,SAAS,CAACS,IAAvD,EAA6DT,SAAS,CAACX,IAAvE,CAAb;AACA,QAAIE,EAAE,IAAIA,EAAE,CAACmB,UAAT,IAAuB,CAACnB,EAAE,CAACmB,UAAH,CAAcJ,IAAd,CAA5B,EAAiD;AACjDD,IAAAA,QAAQ,GAAG,MAAMP,OAAO,CAACa,OAAR,CAAgBC,WAAhB,CAA4BN,IAA5B,CAAjB;AACAL,IAAAA,QAAQ,GAAG,IAAIT,KAAJ,CAAUa,QAAV,CAAX;AACD;;AACD,QAAMQ,WAAW,GAAG,MAAMZ,QAAQ,CAACa,GAAT,CAAa,aAAb,CAA1B;;AACA,MAAI,CAACD,WAAL,EAAkB;AAElB,QAAME,OAAO,GAAGf,SAAS,CAACgB,QAAV,EAAhB;AACAtB,EAAAA,MAAM,CAACuB,KAAP,CAAa,+CAAb;AACA,QAAMC,aAAa,GAAG,CACpB,cADoB,EAEpB,aAFoB,EAGpB,UAHoB,EAIpB,OAJoB,CAAtB;;AAOA,OAAK,MAAMC,CAAX,IAAgBD,aAAhB,EAA+B;AAC7B,QAAI;AACF,YAAME,GAAG,GAAG/B,IAAI,CAACmB,IAAL,CAAUO,OAAV,EAAmBG,aAAa,CAACC,CAAD,CAAhC,CAAZ;AACA,YAAME,GAAG,GAAG,MAAMpB,QAAQ,CAACa,GAAT,CAAaI,aAAa,CAACC,CAAD,CAA1B,CAAlB;AACA,UAAIE,GAAJ,EAAS,MAAMtB,OAAO,CAACK,KAAR,CAAckB,GAAd,CAAkBF,GAAlB,EAAuBC,GAAvB,CAAN;AACV,KAJD,CAIE,OAAOE,CAAP,EAAU;AACV7B,MAAAA,MAAM,CAACuB,KAAP,CAAaM,CAAC,CAACC,OAAf;AACD;AACF;;AACD,QAAMzB,OAAO,CAACK,KAAR,CAAckB,GAAd,CAAkBjC,IAAI,CAACmB,IAAL,CAAUO,OAAV,EAAmB,WAAnB,CAAlB,EAAmDf,SAAS,CAACS,IAA7D,CAAN;AACA,MAAIJ,QAAJ,EAAc,MAAMA,QAAQ,CAACoB,KAAT,EAAN;AACf;;AAEDC,MAAM,CAACC,OAAP,GAAiB9B,OAAjB","sourcesContent":["const path = require('path')\nconst fs = require('../fs-shim')\n\nconst Cache = require('orbit-db-cache')\n\nconst Logger = require('logplease')\nconst logger = Logger.create('orbit-db')\nLogger.setLogLevel('ERROR')\n\nasync function migrate (OrbitDB, options, dbAddress) {\n  let oldCache = OrbitDB.caches[options.directory] ? OrbitDB.caches[options.directory].cache : null\n  let oldStore\n\n  if (!oldCache) {\n    const addr = (path.posix || path).join(OrbitDB.directory, dbAddress.root, dbAddress.path)\n    if (fs && fs.existsSync && !fs.existsSync(addr)) return\n    oldStore = await OrbitDB.storage.createStore(addr)\n    oldCache = new Cache(oldStore)\n  }\n  const _localHeads = await oldCache.get('_localHeads')\n  if (!_localHeads) return\n\n  const keyRoot = dbAddress.toString()\n  logger.debug('Attempting to migrate from old cache location')\n  const migrationKeys = [\n    '_remoteHeads',\n    '_localHeads',\n    'snapshot',\n    'queue'\n  ]\n\n  for (const i in migrationKeys) {\n    try {\n      const key = path.join(keyRoot, migrationKeys[i])\n      const val = await oldCache.get(migrationKeys[i])\n      if (val) await options.cache.set(key, val)\n    } catch (e) {\n      logger.debug(e.message)\n    }\n  }\n  await options.cache.set(path.join(keyRoot, '_manifest'), dbAddress.root)\n  if (oldStore) await oldStore.close()\n}\n\nmodule.exports = migrate\n"]},"metadata":{},"sourceType":"script"}