{"ast":null,"code":"'use strict';\n\nconst pMapSeries = require('p-map-series');\n\nconst AccessController = require('./access-controller-interface');\n\nconst ensureAddress = require('./utils/ensure-ac-address');\n\nconst type = 'orbitdb';\n\nclass OrbitDBAccessController extends AccessController {\n  constructor(orbitdb, options) {\n    super();\n    this._orbitdb = orbitdb;\n    this._db = null;\n    this._options = options || {};\n  } // Returns the type of the access controller\n\n\n  static get type() {\n    return type;\n  } // Returns the address of the OrbitDB used as the AC\n\n\n  get address() {\n    return this._db.address;\n  } // Return true if entry is allowed to be added to the database\n\n\n  async canAppend(entry, identityProvider) {\n    // Write keys and admins keys are allowed\n    const access = new Set([...this.get('write'), ...this.get('admin')]); // If the ACL contains the writer's public key or it contains '*'\n\n    if (access.has(entry.identity.id) || access.has('*')) {\n      const verifiedIdentity = await identityProvider.verifyIdentity(entry.identity); // Allow access if identity verifies\n\n      return verifiedIdentity;\n    }\n\n    return false;\n  }\n\n  get capabilities() {\n    if (this._db) {\n      const capabilities = this._db.index;\n\n      const toSet = e => {\n        const key = e[0];\n        capabilities[key] = new Set([...(capabilities[key] || []), ...e[1]]);\n      }; // Merge with the access controller of the database\n      // and make sure all values are Sets\n\n\n      Object.entries({ ...capabilities,\n        // Add the root access controller's 'write' access list\n        // as admins on this controller\n        ...{\n          admin: new Set([...(capabilities.admin || []), ...this._db.access.write])\n        }\n      }).forEach(toSet);\n      return capabilities;\n    }\n\n    return {};\n  }\n\n  get(capability) {\n    return this.capabilities[capability] || new Set([]);\n  }\n\n  async close() {\n    await this._db.close();\n  }\n\n  async load(address) {\n    if (this._db) {\n      await this._db.close();\n    } // Force '<address>/_access' naming for the database\n\n\n    this._db = await this._orbitdb.keyvalue(ensureAddress(address), {\n      // use ipfs controller as a immutable \"root controller\"\n      accessController: {\n        type: 'ipfs',\n        write: this._options.admin || [this._orbitdb.identity.id]\n      },\n      sync: true\n    });\n\n    this._db.events.on('ready', this._onUpdate.bind(this));\n\n    this._db.events.on('write', this._onUpdate.bind(this));\n\n    this._db.events.on('replicated', this._onUpdate.bind(this));\n\n    await this._db.load();\n  }\n\n  async save() {\n    // return the manifest data\n    return {\n      address: this._db.address.toString()\n    };\n  }\n\n  async grant(capability, key) {\n    // Merge current keys with the new key\n    const capabilities = new Set([...(this._db.get(capability) || []), ...[key]]);\n    await this._db.put(capability, Array.from(capabilities.values()));\n  }\n\n  async revoke(capability, key) {\n    const capabilities = new Set(this._db.get(capability) || []);\n    capabilities.delete(key);\n\n    if (capabilities.size > 0) {\n      await this._db.put(capability, Array.from(capabilities.values()));\n    } else {\n      await this._db.del(capability);\n    }\n  }\n  /* Private methods */\n\n\n  _onUpdate() {\n    this.emit('updated');\n  }\n  /* Factory */\n\n\n  static async create(orbitdb, options = {}) {\n    const ac = new OrbitDBAccessController(orbitdb, options);\n    await ac.load(options.address || options.name || 'default-access-controller'); // Add write access from options\n\n    if (options.write && !options.address) {\n      await pMapSeries(options.write, async e => ac.grant('write', e));\n    }\n\n    return ac;\n  }\n\n}\n\nmodule.exports = OrbitDBAccessController;","map":{"version":3,"sources":["/home/user/orbit-playground/music-app/node_modules/orbit-db-access-controllers/src/orbitdb-access-controller.js"],"names":["pMapSeries","require","AccessController","ensureAddress","type","OrbitDBAccessController","constructor","orbitdb","options","_orbitdb","_db","_options","address","canAppend","entry","identityProvider","access","Set","get","has","identity","id","verifiedIdentity","verifyIdentity","capabilities","index","toSet","e","key","Object","entries","admin","write","forEach","capability","close","load","keyvalue","accessController","sync","events","on","_onUpdate","bind","save","toString","grant","put","Array","from","values","revoke","delete","size","del","emit","create","ac","name","module","exports"],"mappings":"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","sourcesContent":["'use strict'\n\nconst pMapSeries = require('p-map-series')\nconst AccessController = require('./access-controller-interface')\nconst ensureAddress = require('./utils/ensure-ac-address')\n\nconst type = 'orbitdb'\n\nclass OrbitDBAccessController extends AccessController {\n  constructor (orbitdb, options) {\n    super()\n    this._orbitdb = orbitdb\n    this._db = null\n    this._options = options || {}\n  }\n\n  // Returns the type of the access controller\n  static get type () { return type }\n\n  // Returns the address of the OrbitDB used as the AC\n  get address () {\n    return this._db.address\n  }\n\n  // Return true if entry is allowed to be added to the database\n  async canAppend (entry, identityProvider) {\n    // Write keys and admins keys are allowed\n    const access = new Set([...this.get('write'), ...this.get('admin')])\n    // If the ACL contains the writer's public key or it contains '*'\n    if (access.has(entry.identity.id) || access.has('*')) {\n      const verifiedIdentity = await identityProvider.verifyIdentity(entry.identity)\n      // Allow access if identity verifies\n      return verifiedIdentity\n    }\n\n    return false\n  }\n\n  get capabilities () {\n    if (this._db) {\n      const capabilities = this._db.index\n\n      const toSet = (e) => {\n        const key = e[0]\n        capabilities[key] = new Set([...(capabilities[key] || []), ...e[1]])\n      }\n\n      // Merge with the access controller of the database\n      // and make sure all values are Sets\n      Object.entries({\n        ...capabilities,\n        // Add the root access controller's 'write' access list\n        // as admins on this controller\n        ...{ admin: new Set([...(capabilities.admin || []), ...this._db.access.write]) }\n      }).forEach(toSet)\n\n      return capabilities\n    }\n    return {}\n  }\n\n  get (capability) {\n    return this.capabilities[capability] || new Set([])\n  }\n\n  async close () {\n    await this._db.close()\n  }\n\n  async load (address) {\n    if (this._db) { await this._db.close() }\n\n    // Force '<address>/_access' naming for the database\n    this._db = await this._orbitdb.keyvalue(ensureAddress(address), {\n      // use ipfs controller as a immutable \"root controller\"\n      accessController: {\n        type: 'ipfs',\n        write: this._options.admin || [this._orbitdb.identity.id]\n      },\n      sync: true\n    })\n\n    this._db.events.on('ready', this._onUpdate.bind(this))\n    this._db.events.on('write', this._onUpdate.bind(this))\n    this._db.events.on('replicated', this._onUpdate.bind(this))\n\n    await this._db.load()\n  }\n\n  async save () {\n    // return the manifest data\n    return {\n      address: this._db.address.toString()\n    }\n  }\n\n  async grant (capability, key) {\n    // Merge current keys with the new key\n    const capabilities = new Set([...(this._db.get(capability) || []), ...[key]])\n    await this._db.put(capability, Array.from(capabilities.values()))\n  }\n\n  async revoke (capability, key) {\n    const capabilities = new Set(this._db.get(capability) || [])\n    capabilities.delete(key)\n    if (capabilities.size > 0) {\n      await this._db.put(capability, Array.from(capabilities.values()))\n    } else {\n      await this._db.del(capability)\n    }\n  }\n\n  /* Private methods */\n  _onUpdate () {\n    this.emit('updated')\n  }\n\n  /* Factory */\n  static async create (orbitdb, options = {}) {\n    const ac = new OrbitDBAccessController(orbitdb, options)\n    await ac.load(options.address || options.name || 'default-access-controller')\n\n    // Add write access from options\n    if (options.write && !options.address) {\n      await pMapSeries(options.write, async (e) => ac.grant('write', e))\n    }\n\n    return ac\n  }\n}\n\nmodule.exports = OrbitDBAccessController\n"]},"metadata":{},"sourceType":"script"}