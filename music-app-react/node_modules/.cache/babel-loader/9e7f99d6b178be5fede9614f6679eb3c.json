{"ast":null,"code":"'use strict';\n\nconst log = require('debug')('ipfs:components:start');\n\nconst Bitswap = require('ipfs-bitswap');\n\nconst multiaddr = require('multiaddr');\n\nconst get = require('dlv');\n\nconst defer = require('p-defer');\n\nconst errCode = require('err-code');\n\nconst IPNS = require('../ipns');\n\nconst routingConfig = require('../ipns/routing/config');\n\nconst {\n  AlreadyInitializedError,\n  NotEnabledError\n} = require('../errors');\n\nconst Components = require('./');\n\nconst createMfsPreload = require('../mfs-preload');\n\nconst {\n  withTimeoutOption\n} = require('../utils');\n\nconst WEBSOCKET_STAR_PROTO_CODE = 479;\n\nmodule.exports = ({\n  apiManager,\n  options: constructorOptions,\n  blockService,\n  gcLock,\n  initOptions,\n  ipld,\n  keychain,\n  peerId,\n  pinManager,\n  preload,\n  print,\n  repo\n}) => withTimeoutOption(async function start() {\n  const startPromise = defer();\n  startPromise.promise.catch(err => log(err));\n  const {\n    cancel\n  } = apiManager.update({\n    start: () => startPromise.promise\n  });\n\n  try {\n    // The repo may be closed if previously stopped\n    if (repo.closed) {\n      await repo.open();\n    }\n\n    const config = await repo.config.getAll();\n    const addrs = [];\n\n    if (config.Addresses && config.Addresses.Swarm) {\n      config.Addresses.Swarm.forEach(addr => {\n        let ma = multiaddr(addr); // Temporary error for users migrating using websocket-star multiaddrs for listenning on libp2p\n        // websocket-star support was removed from ipfs and libp2p\n\n        if (ma.protoCodes().includes(WEBSOCKET_STAR_PROTO_CODE)) {\n          throw errCode(new Error('websocket-star swarm addresses are not supported. See https://github.com/ipfs/js-ipfs/issues/2779'), 'ERR_WEBSOCKET_STAR_SWARM_ADDR_NOT_SUPPORTED');\n        } // multiaddrs that go via a signalling server or other intermediary (e.g. stardust,\n        // webrtc-star) can have the intermediary's peer ID in the address, so append our\n        // peer ID to the end of it\n\n\n        const maId = ma.getPeerId();\n\n        if (maId && maId !== peerId.toB58String()) {\n          ma = ma.encapsulate(`/p2p/${peerId.toB58String()}`);\n        }\n\n        addrs.push(ma);\n      });\n    }\n\n    const libp2p = Components.libp2p({\n      options: constructorOptions,\n      repo,\n      peerId: peerId,\n      multiaddrs: addrs,\n      config\n    });\n    libp2p.keychain && (await libp2p.loadKeychain());\n    await libp2p.start();\n    libp2p.transportManager.getAddrs().forEach(ma => print(`Swarm listening on ${ma}/p2p/${peerId.toB58String()}`));\n    const ipnsRouting = routingConfig({\n      libp2p,\n      repo,\n      peerId,\n      options: constructorOptions\n    });\n    const ipns = new IPNS(ipnsRouting, repo.datastore, peerId, keychain, {\n      pass: initOptions.pass\n    });\n    const bitswap = new Bitswap(libp2p, repo.blocks, {\n      statsEnabled: true\n    });\n    await bitswap.start();\n    blockService.setExchange(bitswap);\n    const dag = {\n      get: Components.dag.get({\n        ipld,\n        preload\n      }),\n      resolve: Components.dag.resolve({\n        ipld,\n        preload\n      }),\n      tree: Components.dag.tree({\n        ipld,\n        preload\n      })\n    };\n    const pinAddAll = Components.pin.addAll({\n      pinManager,\n      gcLock,\n      dag\n    });\n    const pinRmAll = Components.pin.rmAll({\n      pinManager,\n      gcLock,\n      dag\n    });\n    const pin = {\n      add: Components.pin.add({\n        addAll: pinAddAll\n      }),\n      addAll: pinAddAll,\n      ls: Components.pin.ls({\n        pinManager,\n        dag\n      }),\n      rm: Components.pin.rm({\n        rmAll: pinRmAll\n      }),\n      rmAll: pinRmAll\n    }; // FIXME: resolve this circular dependency\n\n    dag.put = Components.dag.put({\n      ipld,\n      pin,\n      gcLock,\n      preload\n    });\n    const block = {\n      get: Components.block.get({\n        blockService,\n        preload\n      }),\n      put: Components.block.put({\n        blockService,\n        pin,\n        gcLock,\n        preload\n      }),\n      rm: Components.block.rm({\n        blockService,\n        gcLock,\n        pinManager\n      }),\n      stat: Components.block.stat({\n        blockService,\n        preload\n      })\n    };\n    const files = Components.files({\n      ipld,\n      block,\n      blockService,\n      repo,\n      preload,\n      options: constructorOptions\n    });\n    const mfsPreload = createMfsPreload({\n      files,\n      preload,\n      options: constructorOptions.preload\n    });\n    await Promise.all([ipns.republisher.start(), preload.start(), mfsPreload.start()]);\n    const api = createApi({\n      apiManager,\n      bitswap,\n      block,\n      blockService,\n      config,\n      constructorOptions,\n      dag,\n      files,\n      gcLock,\n      initOptions,\n      ipld,\n      ipns,\n      keychain,\n      libp2p,\n      mfsPreload,\n      peerId,\n      pin,\n      pinManager,\n      preload,\n      print,\n      repo\n    });\n    apiManager.update(api, () => undefined);\n    /** @type {typeof api} */\n\n    const startedApi = apiManager.api;\n    startPromise.resolve(startedApi);\n    return startedApi;\n  } catch (err) {\n    cancel();\n    startPromise.reject(err);\n    throw err;\n  }\n}); // eslint-disable-next-line valid-jsdoc\n\n/**\n * @template LIBP2P\n * @template BlockAPI, DagAPI, FilesAPI, PinAPI\n * @param {{ [x: string]: any; libp2p: LIBP2P; block: BlockAPI; dag: DagAPI; files: FilesAPI; pin: PinAPI; }} options\n */\n\n\nfunction createApi({\n  apiManager,\n  bitswap,\n  block,\n  blockService,\n  config,\n  constructorOptions,\n  dag,\n  files,\n  gcLock,\n  initOptions,\n  ipld,\n  ipns,\n  keychain,\n  libp2p,\n  mfsPreload,\n  peerId,\n  pin,\n  pinManager,\n  preload,\n  print,\n  repo\n}) {\n  const object = {\n    data: Components.object.data({\n      ipld,\n      preload\n    }),\n    get: Components.object.get({\n      ipld,\n      preload\n    }),\n    links: Components.object.links({\n      dag\n    }),\n    new: Components.object.new({\n      ipld,\n      preload\n    }),\n    patch: {\n      addLink: Components.object.patch.addLink({\n        ipld,\n        gcLock,\n        preload\n      }),\n      appendData: Components.object.patch.appendData({\n        ipld,\n        gcLock,\n        preload\n      }),\n      rmLink: Components.object.patch.rmLink({\n        ipld,\n        gcLock,\n        preload\n      }),\n      setData: Components.object.patch.setData({\n        ipld,\n        gcLock,\n        preload\n      })\n    },\n    put: Components.object.put({\n      ipld,\n      gcLock,\n      preload\n    }),\n    stat: Components.object.stat({\n      ipld,\n      preload\n    })\n  };\n  const addAll = Components.addAll({\n    block,\n    preload,\n    pin,\n    gcLock,\n    options: constructorOptions\n  });\n  const isOnline = Components.isOnline({\n    libp2p\n  });\n\n  const dhtNotEnabled = async () => {\n    // eslint-disable-line require-await\n    throw new NotEnabledError('dht not enabled');\n  };\n\n  const dhtNotEnabledIterator = async function* () {\n    // eslint-disable-line require-await,require-yield\n    throw new NotEnabledError('dht not enabled');\n  };\n\n  const dht = get(libp2p, '_config.dht.enabled', false) ? Components.dht({\n    libp2p,\n    repo\n  }) : {\n    get: dhtNotEnabled,\n    put: dhtNotEnabled,\n    findProvs: dhtNotEnabledIterator,\n    findPeer: dhtNotEnabled,\n    provide: dhtNotEnabledIterator,\n    query: dhtNotEnabledIterator\n  };\n  const dns = Components.dns();\n  const name = {\n    pubsub: {\n      cancel: Components.name.pubsub.cancel({\n        ipns,\n        options: constructorOptions\n      }),\n      state: Components.name.pubsub.state({\n        ipns,\n        options: constructorOptions\n      }),\n      subs: Components.name.pubsub.subs({\n        ipns,\n        options: constructorOptions\n      })\n    },\n    publish: Components.name.publish({\n      ipns,\n      dag,\n      peerId,\n      isOnline,\n      keychain,\n      options: constructorOptions\n    }),\n    resolve: Components.name.resolve({\n      dns,\n      ipns,\n      peerId,\n      isOnline,\n      options: constructorOptions\n    })\n  };\n  const resolve = Components.resolve({\n    name,\n    ipld\n  });\n  const refs = Object.assign(Components.refs({\n    ipld,\n    resolve,\n    preload\n  }), {\n    local: Components.refs.local({\n      repo\n    })\n  });\n\n  const pubsubNotEnabled = async () => {\n    // eslint-disable-line require-await\n    throw new NotEnabledError('pubsub not enabled');\n  };\n\n  const pubsub = get(constructorOptions, 'config.Pubsub.Enabled', get(config, 'Pubsub.Enabled', true)) ? Components.pubsub({\n    libp2p\n  }) : {\n    subscribe: pubsubNotEnabled,\n    unsubscribe: pubsubNotEnabled,\n    publish: pubsubNotEnabled,\n    ls: pubsubNotEnabled,\n    peers: pubsubNotEnabled\n  };\n  const api = {\n    add: Components.add({\n      addAll\n    }),\n    addAll,\n    bitswap: {\n      stat: Components.bitswap.stat({\n        bitswap\n      }),\n      unwant: Components.bitswap.unwant({\n        bitswap\n      }),\n      wantlist: Components.bitswap.wantlist({\n        bitswap\n      }),\n      wantlistForPeer: Components.bitswap.wantlistForPeer({\n        bitswap\n      })\n    },\n    block,\n    bootstrap: {\n      add: Components.bootstrap.add({\n        repo\n      }),\n      clear: Components.bootstrap.clear({\n        repo\n      }),\n      list: Components.bootstrap.list({\n        repo\n      }),\n      reset: Components.bootstrap.reset({\n        repo\n      }),\n      rm: Components.bootstrap.rm({\n        repo\n      })\n    },\n    cat: Components.cat({\n      ipld,\n      preload\n    }),\n    config: Components.config({\n      repo\n    }),\n    dag,\n    dht,\n    dns,\n    files,\n    get: Components.get({\n      ipld,\n      preload\n    }),\n    id: Components.id({\n      peerId,\n      libp2p\n    }),\n    init: async () => {\n      throw new AlreadyInitializedError();\n    },\n    // eslint-disable-line require-await\n    isOnline,\n    key: {\n      export: Components.key.export({\n        keychain\n      }),\n      gen: Components.key.gen({\n        keychain\n      }),\n      import: Components.key.import({\n        keychain\n      }),\n      info: Components.key.info({\n        keychain\n      }),\n      list: Components.key.list({\n        keychain\n      }),\n      rename: Components.key.rename({\n        keychain\n      }),\n      rm: Components.key.rm({\n        keychain\n      })\n    },\n    libp2p,\n    ls: Components.ls({\n      ipld,\n      preload\n    }),\n    name,\n    object,\n    pin,\n    ping: Components.ping({\n      libp2p\n    }),\n    pubsub,\n    refs,\n    repo: {\n      gc: Components.repo.gc({\n        gcLock,\n        pin,\n        refs,\n        repo\n      }),\n      stat: Components.repo.stat({\n        repo\n      }),\n      version: Components.repo.version({\n        repo\n      })\n    },\n    resolve,\n    start: () => apiManager.api,\n    stats: {\n      bitswap: Components.bitswap.stat({\n        bitswap\n      }),\n      bw: libp2p.metrics ? Components.stats.bw({\n        libp2p\n      }) : async () => {\n        // eslint-disable-line require-await\n        throw new NotEnabledError('libp2p metrics not enabled');\n      },\n      repo: Components.repo.stat({\n        repo\n      })\n    },\n    stop: Components.stop({\n      apiManager,\n      bitswap,\n      options: constructorOptions,\n      blockService,\n      gcLock,\n      initOptions,\n      ipld,\n      ipns,\n      keychain,\n      libp2p,\n      mfsPreload,\n      peerId,\n      preload,\n      print,\n      repo\n    }),\n    swarm: {\n      addrs: Components.swarm.addrs({\n        libp2p\n      }),\n      connect: Components.swarm.connect({\n        libp2p\n      }),\n      disconnect: Components.swarm.disconnect({\n        libp2p\n      }),\n      localAddrs: Components.swarm.localAddrs({\n        multiaddrs: libp2p.multiaddrs\n      }),\n      peers: Components.swarm.peers({\n        libp2p\n      })\n    },\n    version: Components.version({\n      repo\n    })\n  };\n  return api;\n}","map":{"version":3,"sources":["/home/user/orbit-playground/music-app/node_modules/ipfs/src/core/components/start.js"],"names":["log","require","Bitswap","multiaddr","get","defer","errCode","IPNS","routingConfig","AlreadyInitializedError","NotEnabledError","Components","createMfsPreload","withTimeoutOption","WEBSOCKET_STAR_PROTO_CODE","module","exports","apiManager","options","constructorOptions","blockService","gcLock","initOptions","ipld","keychain","peerId","pinManager","preload","print","repo","start","startPromise","promise","catch","err","cancel","update","closed","open","config","getAll","addrs","Addresses","Swarm","forEach","addr","ma","protoCodes","includes","Error","maId","getPeerId","toB58String","encapsulate","push","libp2p","multiaddrs","loadKeychain","transportManager","getAddrs","ipnsRouting","ipns","datastore","pass","bitswap","blocks","statsEnabled","setExchange","dag","resolve","tree","pinAddAll","pin","addAll","pinRmAll","rmAll","add","ls","rm","put","block","stat","files","mfsPreload","Promise","all","republisher","api","createApi","undefined","startedApi","reject","object","data","links","new","patch","addLink","appendData","rmLink","setData","isOnline","dhtNotEnabled","dhtNotEnabledIterator","dht","findProvs","findPeer","provide","query","dns","name","pubsub","state","subs","publish","refs","Object","assign","local","pubsubNotEnabled","subscribe","unsubscribe","peers","unwant","wantlist","wantlistForPeer","bootstrap","clear","list","reset","cat","id","init","key","export","gen","import","info","rename","ping","gc","version","stats","bw","metrics","stop","swarm","connect","disconnect","localAddrs"],"mappings":"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","sourcesContent":["'use strict'\n\nconst log = require('debug')('ipfs:components:start')\nconst Bitswap = require('ipfs-bitswap')\nconst multiaddr = require('multiaddr')\nconst get = require('dlv')\nconst defer = require('p-defer')\nconst errCode = require('err-code')\nconst IPNS = require('../ipns')\nconst routingConfig = require('../ipns/routing/config')\nconst { AlreadyInitializedError, NotEnabledError } = require('../errors')\nconst Components = require('./')\nconst createMfsPreload = require('../mfs-preload')\nconst { withTimeoutOption } = require('../utils')\n\nconst WEBSOCKET_STAR_PROTO_CODE = 479\n\nmodule.exports = ({\n  apiManager,\n  options: constructorOptions,\n  blockService,\n  gcLock,\n  initOptions,\n  ipld,\n  keychain,\n  peerId,\n  pinManager,\n  preload,\n  print,\n  repo\n}) => withTimeoutOption(async function start () {\n  const startPromise = defer()\n  startPromise.promise.catch((err) => log(err))\n\n  const { cancel } = apiManager.update({ start: () => startPromise.promise })\n\n  try {\n    // The repo may be closed if previously stopped\n    if (repo.closed) {\n      await repo.open()\n    }\n\n    const config = await repo.config.getAll()\n    const addrs = []\n\n    if (config.Addresses && config.Addresses.Swarm) {\n      config.Addresses.Swarm.forEach(addr => {\n        let ma = multiaddr(addr)\n\n        // Temporary error for users migrating using websocket-star multiaddrs for listenning on libp2p\n        // websocket-star support was removed from ipfs and libp2p\n        if (ma.protoCodes().includes(WEBSOCKET_STAR_PROTO_CODE)) {\n          throw errCode(new Error('websocket-star swarm addresses are not supported. See https://github.com/ipfs/js-ipfs/issues/2779'), 'ERR_WEBSOCKET_STAR_SWARM_ADDR_NOT_SUPPORTED')\n        }\n\n        // multiaddrs that go via a signalling server or other intermediary (e.g. stardust,\n        // webrtc-star) can have the intermediary's peer ID in the address, so append our\n        // peer ID to the end of it\n        const maId = ma.getPeerId()\n        if (maId && maId !== peerId.toB58String()) {\n          ma = ma.encapsulate(`/p2p/${peerId.toB58String()}`)\n        }\n\n        addrs.push(ma)\n      })\n    }\n\n    const libp2p = Components.libp2p({\n      options: constructorOptions,\n      repo,\n      peerId: peerId,\n      multiaddrs: addrs,\n      config\n    })\n\n    libp2p.keychain && await libp2p.loadKeychain()\n\n    await libp2p.start()\n\n    libp2p.transportManager.getAddrs().forEach(ma => print(`Swarm listening on ${ma}/p2p/${peerId.toB58String()}`))\n\n    const ipnsRouting = routingConfig({ libp2p, repo, peerId, options: constructorOptions })\n    const ipns = new IPNS(ipnsRouting, repo.datastore, peerId, keychain, { pass: initOptions.pass })\n    const bitswap = new Bitswap(libp2p, repo.blocks, { statsEnabled: true })\n\n    await bitswap.start()\n\n    blockService.setExchange(bitswap)\n\n    const dag = {\n      get: Components.dag.get({ ipld, preload }),\n      resolve: Components.dag.resolve({ ipld, preload }),\n      tree: Components.dag.tree({ ipld, preload })\n    }\n\n    const pinAddAll = Components.pin.addAll({ pinManager, gcLock, dag })\n    const pinRmAll = Components.pin.rmAll({ pinManager, gcLock, dag })\n\n    const pin = {\n      add: Components.pin.add({ addAll: pinAddAll }),\n      addAll: pinAddAll,\n      ls: Components.pin.ls({ pinManager, dag }),\n      rm: Components.pin.rm({ rmAll: pinRmAll }),\n      rmAll: pinRmAll\n    }\n\n    // FIXME: resolve this circular dependency\n    dag.put = Components.dag.put({ ipld, pin, gcLock, preload })\n\n    const block = {\n      get: Components.block.get({ blockService, preload }),\n      put: Components.block.put({ blockService, pin, gcLock, preload }),\n      rm: Components.block.rm({ blockService, gcLock, pinManager }),\n      stat: Components.block.stat({ blockService, preload })\n    }\n\n    const files = Components.files({ ipld, block, blockService, repo, preload, options: constructorOptions })\n    const mfsPreload = createMfsPreload({ files, preload, options: constructorOptions.preload })\n\n    await Promise.all([\n      ipns.republisher.start(),\n      preload.start(),\n      mfsPreload.start()\n    ])\n\n    const api = createApi({\n      apiManager,\n      bitswap,\n      block,\n      blockService,\n      config,\n      constructorOptions,\n      dag,\n      files,\n      gcLock,\n      initOptions,\n      ipld,\n      ipns,\n      keychain,\n      libp2p,\n      mfsPreload,\n      peerId,\n      pin,\n      pinManager,\n      preload,\n      print,\n      repo\n    })\n\n    apiManager.update(api, () => undefined)\n\n    /** @type {typeof api} */\n    const startedApi = apiManager.api\n    startPromise.resolve(startedApi)\n    return startedApi\n  } catch (err) {\n    cancel()\n    startPromise.reject(err)\n    throw err\n  }\n})\n\n// eslint-disable-next-line valid-jsdoc\n/**\n * @template LIBP2P\n * @template BlockAPI, DagAPI, FilesAPI, PinAPI\n * @param {{ [x: string]: any; libp2p: LIBP2P; block: BlockAPI; dag: DagAPI; files: FilesAPI; pin: PinAPI; }} options\n */\nfunction createApi ({\n  apiManager,\n  bitswap,\n  block,\n  blockService,\n  config,\n  constructorOptions,\n  dag,\n  files,\n  gcLock,\n  initOptions,\n  ipld,\n  ipns,\n  keychain,\n  libp2p,\n  mfsPreload,\n  peerId,\n  pin,\n  pinManager,\n  preload,\n  print,\n  repo\n}) {\n  const object = {\n    data: Components.object.data({ ipld, preload }),\n    get: Components.object.get({ ipld, preload }),\n    links: Components.object.links({ dag }),\n    new: Components.object.new({ ipld, preload }),\n    patch: {\n      addLink: Components.object.patch.addLink({ ipld, gcLock, preload }),\n      appendData: Components.object.patch.appendData({ ipld, gcLock, preload }),\n      rmLink: Components.object.patch.rmLink({ ipld, gcLock, preload }),\n      setData: Components.object.patch.setData({ ipld, gcLock, preload })\n    },\n    put: Components.object.put({ ipld, gcLock, preload }),\n    stat: Components.object.stat({ ipld, preload })\n  }\n\n  const addAll = Components.addAll({ block, preload, pin, gcLock, options: constructorOptions })\n  const isOnline = Components.isOnline({ libp2p })\n\n  const dhtNotEnabled = async () => { // eslint-disable-line require-await\n    throw new NotEnabledError('dht not enabled')\n  }\n\n  const dhtNotEnabledIterator = async function * () { // eslint-disable-line require-await,require-yield\n    throw new NotEnabledError('dht not enabled')\n  }\n\n  const dht = get(libp2p, '_config.dht.enabled', false) ? Components.dht({ libp2p, repo }) : {\n    get: dhtNotEnabled,\n    put: dhtNotEnabled,\n    findProvs: dhtNotEnabledIterator,\n    findPeer: dhtNotEnabled,\n    provide: dhtNotEnabledIterator,\n    query: dhtNotEnabledIterator\n  }\n\n  const dns = Components.dns()\n  const name = {\n    pubsub: {\n      cancel: Components.name.pubsub.cancel({ ipns, options: constructorOptions }),\n      state: Components.name.pubsub.state({ ipns, options: constructorOptions }),\n      subs: Components.name.pubsub.subs({ ipns, options: constructorOptions })\n    },\n    publish: Components.name.publish({ ipns, dag, peerId, isOnline, keychain, options: constructorOptions }),\n    resolve: Components.name.resolve({ dns, ipns, peerId, isOnline, options: constructorOptions })\n  }\n  const resolve = Components.resolve({ name, ipld })\n  const refs = Object.assign(\n    Components.refs({ ipld, resolve, preload }),\n    { local: Components.refs.local({ repo }) }\n  )\n\n  const pubsubNotEnabled = async () => { // eslint-disable-line require-await\n    throw new NotEnabledError('pubsub not enabled')\n  }\n\n  const pubsub = get(constructorOptions, 'config.Pubsub.Enabled', get(config, 'Pubsub.Enabled', true))\n    ? Components.pubsub({ libp2p })\n    : {\n      subscribe: pubsubNotEnabled,\n      unsubscribe: pubsubNotEnabled,\n      publish: pubsubNotEnabled,\n      ls: pubsubNotEnabled,\n      peers: pubsubNotEnabled\n    }\n\n  const api = {\n    add: Components.add({ addAll }),\n    addAll,\n    bitswap: {\n      stat: Components.bitswap.stat({ bitswap }),\n      unwant: Components.bitswap.unwant({ bitswap }),\n      wantlist: Components.bitswap.wantlist({ bitswap }),\n      wantlistForPeer: Components.bitswap.wantlistForPeer({ bitswap })\n    },\n    block,\n    bootstrap: {\n      add: Components.bootstrap.add({ repo }),\n      clear: Components.bootstrap.clear({ repo }),\n      list: Components.bootstrap.list({ repo }),\n      reset: Components.bootstrap.reset({ repo }),\n      rm: Components.bootstrap.rm({ repo })\n    },\n    cat: Components.cat({ ipld, preload }),\n    config: Components.config({ repo }),\n    dag,\n    dht,\n    dns,\n    files,\n    get: Components.get({ ipld, preload }),\n    id: Components.id({ peerId, libp2p }),\n    init: async () => { throw new AlreadyInitializedError() }, // eslint-disable-line require-await\n    isOnline,\n    key: {\n      export: Components.key.export({ keychain }),\n      gen: Components.key.gen({ keychain }),\n      import: Components.key.import({ keychain }),\n      info: Components.key.info({ keychain }),\n      list: Components.key.list({ keychain }),\n      rename: Components.key.rename({ keychain }),\n      rm: Components.key.rm({ keychain })\n    },\n    libp2p,\n    ls: Components.ls({ ipld, preload }),\n    name,\n    object,\n    pin,\n    ping: Components.ping({ libp2p }),\n    pubsub,\n    refs,\n    repo: {\n      gc: Components.repo.gc({ gcLock, pin, refs, repo }),\n      stat: Components.repo.stat({ repo }),\n      version: Components.repo.version({ repo })\n    },\n    resolve,\n    start: () => apiManager.api,\n    stats: {\n      bitswap: Components.bitswap.stat({ bitswap }),\n      bw: libp2p.metrics\n        ? Components.stats.bw({ libp2p })\n        : async () => { // eslint-disable-line require-await\n          throw new NotEnabledError('libp2p metrics not enabled')\n        },\n      repo: Components.repo.stat({ repo })\n    },\n    stop: Components.stop({\n      apiManager,\n      bitswap,\n      options: constructorOptions,\n      blockService,\n      gcLock,\n      initOptions,\n      ipld,\n      ipns,\n      keychain,\n      libp2p,\n      mfsPreload,\n      peerId,\n      preload,\n      print,\n      repo\n    }),\n    swarm: {\n      addrs: Components.swarm.addrs({ libp2p }),\n      connect: Components.swarm.connect({ libp2p }),\n      disconnect: Components.swarm.disconnect({ libp2p }),\n      localAddrs: Components.swarm.localAddrs({ multiaddrs: libp2p.multiaddrs }),\n      peers: Components.swarm.peers({ libp2p })\n    },\n    version: Components.version({ repo })\n  }\n\n  return api\n}\n"]},"metadata":{},"sourceType":"script"}